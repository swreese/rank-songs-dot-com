<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üî• NF Songs Ranked | Fan Top 20 Leaderboard</title>

  <!-- Google Tag Manager (GTM) ‚Äì loads GA4 and other pixels via container -->
  <script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NGW77446');
  </script>
  <!-- End GTM -->

  <!-- Mobile + basic SEO -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Rank NF‚Äôs songs and see how your list compares with fans worldwide. Submit your Top 20 and explore the global leaderboard in real time." />
  <link rel="canonical" href="https://ranksongs.com/nf_ranks.html" />
  <meta name="robots" content="index,follow" />

  <!-- Open Graph -->
  <meta property="og:title" content="NF Songs Ranked | Fan Top 20 Leaderboard" />
  <meta property="og:description" content="Rank NF‚Äôs best songs with other fans. Pick your Top 20 and see the global leaderboard update in real time." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://ranksongs.com/nf_ranks.html" />
  <meta property="og:image" content="https://ranksongs.com/NF%20SONG%20RANKS%20WALLPAPER.jpg" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="NF Songs Ranked | Fan Top 20 Leaderboard" />
  <meta name="twitter:description" content="Rank NF‚Äôs best songs with other fans. Pick your Top 20 and see the global leaderboard update in real time." />
  <meta name="twitter:image" content="https://ranksongs.com/NF%20SONG%20RANKS%20WALLPAPER.jpg" />

  <!-- Google AdSense (Auto ads) ‚Äì live publisher ID -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2177244564929875" crossorigin="anonymous"></script>

  <!-- JSON-LD: WebPage + MusicGroup + ItemList + BreadcrumbList -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "WebPage",
        "@id": "https://ranksongs.com/nf_ranks.html#webpage",
        "url": "https://ranksongs.com/nf_ranks.html",
        "name": "NF Songs Ranked | Fan Top 20 Leaderboard",
        "description": "Fans rank NF‚Äôs best songs and see the global Top 20 leaderboard in real time.",
        "primaryImageOfPage": { "@type": "ImageObject", "url": "https://ranksongs.com/NF%20SONG%20RANKS%20WALLPAPER.jpg" }
      },
      {
        "@type": "MusicGroup",
        "@id": "https://ranksongs.com/nf_ranks.html#artist",
        "name": "NF"
      },
      {
        "@type": "ItemList",
        "@id": "https://ranksongs.com/nf_ranks.html#toplist",
        "name": "NF Songs Ranked",
        "itemListOrder": "Descending",
        "numberOfItems": 20,
        "about": { "@id": "https://ranksongs.com/nf_ranks.html#artist" }
      },
      {
        "@type": "BreadcrumbList",
        "@id": "https://ranksongs.com/nf_ranks.html#breadcrumbs",
        "itemListElement": [
          { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://ranksongs.com/index.html" },
          { "@type": "ListItem", "position": 2, "name": "NF Songs Ranked", "item": "https://ranksongs.com/nf_ranks.html" }
        ]
      }
    ]
  }
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 30px auto;
      padding: 10px;
      background-color: #ffffff;
      color: #111827;
      position: relative;
      z-index: 0;
    }
    .hero-heading {
      font-size: 3rem;
      font-weight: 900;
      text-align: center;
      margin-top: 40px;
      margin-bottom: 30px;
      background: linear-gradient(90deg, #111827, #4f46e5, #ec4899);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
      letter-spacing: 1.2px;
    }
    .back-home-btn {
      position: fixed; top: 20px; right: 20px;
      background-color: #0077cc; color: #fff;
      padding: 10px 16px; border-radius: 25px; font-size: 16px;
      text-decoration: none; display: flex; align-items: center; gap: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: background-color .3s ease; z-index: 1000;
    }
    .back-home-btn:hover { background-color: #005fa3; }
    .back-home-btn svg { width: 16px; height: 16px; fill: white; }
    .section-header { text-align: center; font-weight: bold; margin-top: 20px; }
    .toggle-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; margin-bottom: 10px; }
    button.toggle-btn {
      padding: 12px 20px; font-size: 15px; font-weight: 600;
      border-radius: 9999px; border: none; background: #3a3a5c; color: #fff;
      transition: background .3s ease, transform .2s ease; cursor: pointer;
    }
    button.toggle-btn:hover { background: #505080; transform: scale(1.05); }
    button.toggle-btn.active { background: #6c63ff; }
    #container {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 24px;
      justify-content: center;
      align-items: flex-start;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }
    #songList, #rankedColumn {
      width: 48%;
      min-width: 160px;
      max-width: 420px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    #rankedList {
      width: 100%;
      max-width: 100%;
    }
    @media (max-width: 900px) {
      #container {
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: center;
        align-items: flex-start;
        max-width: 100vw;
      }
      #songList, #rankedColumn {
        width: 50vw;
        min-width: 0;
        max-width: 100vw;
      }
    }
    @media (max-width: 600px) {
      #container {
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: center;
        align-items: flex-start;
        width: 100vw;
        max-width: 100vw;
      }
      #songList, #rankedColumn {
        width: 50vw;
        min-width: 0;
        max-width: 100vw;
      }
    }
    #songList {
      width: 48%; max-height: 800px; overflow-y: auto;
      border: 1px solid #ccc; padding: 10px; display: flex; flex-direction: column; gap: 5px;
    }
    .song-item { background-color: #eee; padding: 8px; border-radius: 4px; cursor: pointer; }
    .song-item:hover { background-color: #ddd; }
    #rankedColumn { display: flex; flex-direction: column; width: 48%; gap: 10px; }
    .rank-box { display: flex; align-items: center; padding: 8px; border: 2px dashed #aaa; border-radius: 6px; background-color: #f9f9f9; }
    .rank-number { width: 30px; text-align: center; font-weight: bold; color: #555; }
    .rank-song { flex: 1; padding-left: 10px; }
    #dropdownContainer { display: none; flex-direction: column; align-items: center; margin-top: 20px; gap: 8px; }
    #dropdownContainer label { 
      margin-top: 10px; 
      font-size: 16px; 
      font-weight: bold; 
      color: #333; 
    }
    #dropdownContainer select { 
      width: 70%; 
      max-width: 500px; 
      padding: 12px 16px; 
      margin: 0 auto; 
      display: block; 
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
      cursor: pointer;
    }
    select, option { 
      text-transform: none; 
      font-family: Candara, sans-serif; 
      font-size: 16px;
    }
    
    /* Mobile-specific improvements for dropdowns */
    @media (max-width: 768px) {
      #dropdownContainer select { 
        width: 90%; 
        padding: 14px 18px; 
        font-size: 18px;
        border-radius: 10px;
      }
      #dropdownContainer label {
        font-size: 18px;
      }
      select, option {
        font-size: 18px;
      }
    }
    #submitSection { margin-top: 10px; display: none; flex-direction: row; justify-content: space-between; gap: 10px; width: 100%; }
    #submitBtn, #resetBtn { height: 48px; width: 50%; font-size: 16px; border: none; border-radius: 24px; cursor: pointer; user-select: none; }
    #submitBtn { background-color: royalblue; color: white; }
    #resetBtn { background-color: pink; color: white; }

    .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      overflow-x: auto;
      box-sizing: border-box;
    }
    .modal-content button { margin: 10px; padding: 10px 15px; font-size: 14px; }

    /* Global rankings table (scrollable body) */
    #globalRankingsTable tbody { display: block; max-height: 300px; overflow-y: auto; width: 100%; }
    #globalRankingsTable thead, #globalRankingsTable tbody tr { display: table; width: 100%; table-layout: fixed; }

    @media (max-width: 900px) {
      #container {
        flex-direction: column;
        align-items: center;
        max-width: 100vw;
      }
      #songList, #rankedColumn {
        width: 100%;
        min-width: 0;
        max-width: 100vw;
      }
    }
    @media (max-width: 600px) {
      #container {
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: center;
        align-items: flex-start;
        width: 100vw;
        max-width: 100vw;
      }
      #songList, #rankedColumn {
        width: 50vw;
        min-width: 0;
        max-width: 100vw;
        margin-left: auto;
        margin-right: auto;
      }
    }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NGW77446" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End GTM (noscript) -->

  <h1 class="hero-heading">üî• Rank Your Top 20 NF Songs</h1>

  <!-- Random Quote Section -->
  <div style="max-width:600px;margin:10px auto 20px auto;text-align:center;font-style:italic;font-size:1.1rem;color:#555;padding:0 20px;">
    &ldquo;<span id="randomQuote">Loading quote...</span>&rdquo;
  </div>

  <a href="index.html" class="back-home-btn" aria-label="Back to Home">
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    Back to Home
  </a>

  <!-- Info section for ranking instructions and global leaderboard -->
  <div class="info-section" style="max-width:700px;margin:32px auto 18px auto;padding:18px 24px;background:rgba(255,255,255,0.08);border-radius:18px;box-shadow:0 2px 12px rgba(0,0,0,0.08);font-size:1.15rem;color:#222;text-align:center;">
    <strong>Make your Top 20 and see how it stacks up against fans worldwide.</strong><br>
    The global leaderboard updates in real time as votes come in.<br><br>
    <em>Tip:</em> add your must-have tracks first, fill in the rest, then nudge songs up or down.<br><br>
    <span style="font-size:1.05rem;color:#444;">Explore more artists:
      <a href="kb_ranks.html">KB</a> ¬∑
      <a href="cp_ranks.html">Connor Price</a> ¬∑
      <a href="liv_ranks.html">Livingston</a> ¬∑
      <a href="jj_ranks.html">Jack Johnson</a> ¬∑
      <a href="FAQs.html">FAQs</a>
    </span>
  </div>

    

  <!-- (Optional) Manual AdSense unit ‚Äî uncomment after you have a valid data-ad-slot
  <ins class="adsbygoogle"
       style="display:block; min-height: 280px;"
       data-ad-client="ca-pub-2177244564929875"
       data-ad-slot="REPLACE_WITH_YOUR_SLOT_ID"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script>
  -->

  <!-- Controls -->
  <div class="section-header">Rank With</div>
  <div class="toggle-group" id="rankByToggles">
    <button class="toggle-btn active" data-mode="click">Click-to-Add</button>
    <button class="toggle-btn" data-mode="dropdown">Dropdown</button>
  </div>

  <div class="section-header">Sort By</div>
  <div class="toggle-group" id="sortByToggles">
    <button class="toggle-btn active" data-sort="release">Release Date</button>
    <button class="toggle-btn" data-sort="alpha">Alphabetical</button>
  </div>

  <!-- App -->
  <div id="container">
    <div id="songList" class="column"></div>

    <div id="rankedColumn">
      <div id="rankedList"></div>
      <div id="submitSection">
        <button id="submitBtn">Submit Rankings</button>
        <button id="resetBtn">Reset My Rankings</button>
      </div>
    </div>
  </div>

  <form id="dropdownContainer"></form>

  <!-- Modals -->
  <div id="submitModal" class="modal">
    <div class="modal-content">
      <p>Submit your rankings now?</p>
      <button onclick="window.confirmSubmit(true)">Yes, submit</button>
      <button onclick="window.confirmSubmit(false)">No, go back</button>
    </div>
  </div>

  <div id="resetModal" class="modal">
    <div class="modal-content">
      <p>Reset your list?</p>
      <button onclick="confirmReset(true)">Yes, reset</button>
      <button onclick="confirmReset(false)">No, go back</button>
    </div>
  </div>

  <div id="resultsModal" class="modal">
    <div class="modal-content">
      <h3>üéß My Rankings</h3>
      <ol id="myRankingsList"></ol>
      <div id="shareButtons" style="margin:18px auto 8px auto;max-width:600px;text-align:center;">
        <div style="margin-bottom:8px;font-weight:600;">Share your list</div>
        <a id="share-x"
           href="https://twitter.com/intent/tweet"
           target="_blank" rel="noopener"
           style="display:inline-block;margin:4px 6px;padding:10px 14px;border-radius:9999px;text-decoration:none;background:#1d9bf0;color:#fff;">Post on X</a>
        <a id="share-fb"
           href="https://www.facebook.com/sharer/sharer.php"
           target="_blank" rel="noopener"
           style="display:inline-block;margin:4px 6px;padding:10px 14px;border-radius:9999px;text-decoration:none;background:#1877f2;color:#fff;">Share on Facebook</a>
        <span id="copyMsg" style="display:none;margin-left:10px;color:#34a853;font-weight:600;"></span>
      </div>
      <h3>üåç Global Rankings</h3>
      <table id="globalRankingsTable" border="1" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Song</th>
            <th>Avg Rank</th>
            <th># Times Ranked</th>
            <th>Total Points</th>
            <th>Composite Score</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button type="button" onclick="closeResults()">Close</button>
    </div>
  </div>

  <!-- Facebook Copy Modal -->
  <div id="fbCopyModal" class="modal">
    <div class="modal-content">
      <p>Copy your list for pasting into your Facebook post?</p>
      <button id="fbCopyYes">Yes, copy & share</button>
      <button id="fbCopyNo">No, just share</button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // GA4 loads via GTM (GTM-NGW77446) with Measurement ID G-3KDW9CM0B8
    // We only push events to dataLayer here.

    const supabaseUrl = 'https://xtptcdopoitufrexwtng.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0cHRjZG9wb2l0dWZyZXh3dG5nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NjE4ODUsImV4cCI6MjA2NjQzNzg4NX0.2LeRd-F4aKkObx5ylGxIVQGuDG3VO4lR8BlYshiBoh4';
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let rankedSongs = Array(20).fill(null);
    let currentMode = 'click';
    let sortType = 'release';
    let globalRankings = [];

    const PRIOR_COUNT = 25;  // smoothing votes
    const PRIOR_AVG = 10.5;  // midpoint average rank

    // NF Quotes for random display
    const NF_QUOTES = [
      "Everybody has a dark side. I feel embarrased when they see mine.",
      "The flow is so cold, you would think it was snowin'.",
      "World don't stop just because I'm in a bad mood",
      "Look, hold up, hold up, wait a minute, please.",
      "You are not a baller 'cause your closet's full of Jordan's.",
      "Got so many cadences. No way to pick one. Which bag is my hand in?",
      "I'm on a rampage, hit 'em with the record release.",
      "What's the point of having love with no pain?",
      "'Cause I thought you had me in prison this whole time, but I'm the one holdin' the keys.",
      "2020 could never hold a candle to the present-day me standing here before you.",
      "I been running for a while; they ain't ready for me.",
      "Hey, Nate, how's life?",
      "'Let You Down's' the only song youve heard of? Well, then you're behind.",
      "Grab your own glass and fill it; don't let your fear destroy you, woo!"
    ];

    function getRandomQuote() {
      return NF_QUOTES[Math.floor(Math.random() * NF_QUOTES.length)];
    }

    // Define the master song list once to avoid mismatches  
    const NF_SONGS = [
      "Hands Up","Only One","Thing Called Love","Just Being Me","Intro","Mansion","All I Have","Wait","Wake Up","Face It","Motivated","Notepad","Turn The Music Up","Paralyzed","I'll Keep On","Can You Hold Me",
      "Intro 2","Therapy Session","I Just Wanna Know","How Could You Leave Us","Breathe","Real","Oh Lord","I Can Feel It","Got You On My Mind","Grindin'","Wish You Wouldn't","Statement","All I Do","Lost In The Moment",
      "Warm Up (Single)","Intro III","Outcast","10 Feet Down","Green Lights","Dreams","Let You Down","Destiny","My Life","You're Special","If You Want Love","Know","Remember This","Lie","3 A.M.","One Hundred","Options","Outro",
      "NO NAME","The Search","Leave Me Alone","Change","My Stress","Nate","Time","Returns","When I Grow Up","Only","Let Me Go","Hate Myself","I Miss The Days","No Excuses","Like This","WHY","Thinking","Trauma","Chasing_(Demo)",
      "CLOUDS","THAT'S A JOKE","JUST LIKE YOU","STORY","PRIDEFUL","LOST","LAYERS","DRIFTING","TRUST","PAID MY DUES","HOPE","MOTTO","CAREFUL","MAMA","HAPPY","PANDEMONIUM","SUFFICE","GONE","BULLET","TURN MY BACK","MISTAKE","LET EM PRAY","RUNNING",
      "FEAR","HOME","WHO I WAS","GIVE ME A REASON","SORRY","WASHED UP"
    ];

    function updateButtons(group, activeValue) {
      document.querySelectorAll('#' + group + ' .toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === activeValue || btn.dataset.sort === activeValue);
      });
    }

    function renderSongList() {
      const songListMaster = Array.from(new Set(NF_SONGS));

      const rankedSet = new Set(rankedSongs.filter(Boolean));
      let songs = songListMaster.filter(song => !rankedSet.has(song));
      if (sortType === 'alpha') songs.sort();

      const songList = document.getElementById('songList');
      songList.innerHTML = '';
      songs.forEach(song => {
        const div = document.createElement('div');
        div.className = 'song-item';
        div.textContent = song;
        div.onclick = () => {
          if (currentMode === 'click') {
            const index = rankedSongs.indexOf(null);
            if (index !== -1) {
              rankedSongs[index] = song;
              renderAll();
            }
          }
        };
        songList.appendChild(div);
      });
    }

    function renderRankedList() {
      const rankedList = document.getElementById('rankedList');
      rankedList.innerHTML = '';

      rankedSongs.forEach((song, i) => {
        const box = document.createElement('div');
        box.className = 'rank-box';

        const num = document.createElement('div');
        num.className = 'rank-number';
        num.textContent = i + 1;

        const content = document.createElement('div');
        content.className = 'rank-song';
        content.textContent = song || '';

        if (song) {
          const controls = document.createElement('div');
          controls.style.display = 'flex';
          controls.style.marginLeft = 'auto';
          controls.style.gap = '14px';

          const upBtn = document.createElement('span');
          upBtn.innerHTML = '‚ñ≤';
          upBtn.style.cursor = 'pointer';
          upBtn.onclick = () => { if (i > 0) { [rankedSongs[i - 1], rankedSongs[i]] = [rankedSongs[i], rankedSongs[i - 1]]; renderAll(); }};

          const downBtn = document.createElement('span');
          downBtn.innerHTML = '‚ñº';
          downBtn.style.cursor = 'pointer';
          downBtn.onclick = () => { if (i < rankedSongs.length - 1) { [rankedSongs[i + 1], rankedSongs[i]] = [rankedSongs[i], rankedSongs[i + 1]]; renderAll(); }};

          const removeBtn = document.createElement('span');
          removeBtn.textContent = '√ó';
          removeBtn.style.color = 'red';
          removeBtn.style.cursor = 'pointer';
          removeBtn.style.fontWeight = 'bold';
          removeBtn.style.fontSize = '18px';
          removeBtn.onclick = () => { rankedSongs[i] = null; renderAll(); };

          controls.appendChild(upBtn);
          controls.appendChild(downBtn);
          controls.appendChild(removeBtn);
          box.appendChild(controls);
        }

        box.appendChild(num);
        box.appendChild(content);
        rankedList.appendChild(box);
      });
    }

    function renderDropdown() {
      const container = document.getElementById('dropdownContainer');
      container.innerHTML = '';

      // Use the same master list as renderSongList()
      const songs = Array.from(new Set(NF_SONGS)).sort((a,b) => sortType==='alpha' ? a.localeCompare(b) : 0);

      for (let i = 0; i < 20; i++) {
        const label = document.createElement('label');
        label.textContent = `#${i + 1}`;
        const select = document.createElement('select');

        const selected = rankedSongs[i];
        const picked = new Set(rankedSongs.filter(Boolean));
        const options = songs.map(song => {
          const used = picked.has(song) && song !== selected;
          return `<option value="${song}" ${song === selected ? 'selected' : ''} ${used ? 'disabled' : ''}>${song}</option>`;
        });

        select.innerHTML = '<option value="">Select a song</option>' + options.join('');
        select.onchange = e => {
          const val = e.target.value;
          rankedSongs[i] = songs.find(s => s === val) || null;
          renderDropdown();
          toggleSubmitReset();
        };

        container.appendChild(label);
        container.appendChild(select);
      }
      toggleSubmitReset();
    }

    function toggleSubmitReset() {
      const ready = rankedSongs.every(Boolean);
      document.getElementById('submitSection').style.display = ready ? 'flex' : 'none';
      if (!ready) {
        document.getElementById('submitModal').style.display = 'none';
        document.getElementById('resetModal').style.display = 'none';
      }
    }

    function renderAll() {
      const isDropdown = currentMode === 'dropdown';
      document.getElementById('dropdownContainer').style.display = isDropdown ? 'flex' : 'none';
      document.getElementById('songList').style.display = isDropdown ? 'none' : 'block';
      document.getElementById('rankedList').style.display = isDropdown ? 'none' : 'block';

      renderSongList();
      if (isDropdown) renderDropdown(); else renderRankedList();
      toggleSubmitReset();
    }

    document.getElementById('rankByToggles').addEventListener('click', e => {
      if (e.target.matches('button')) { currentMode = e.target.dataset.mode; updateButtons('rankByToggles', currentMode); renderAll(); }
    });
    document.getElementById('sortByToggles').addEventListener('click', e => {
      if (e.target.matches('button')) { sortType = e.target.dataset.sort; updateButtons('sortByToggles', sortType); renderAll(); }
    });

    document.getElementById('submitBtn').onclick = () => {
      if (rankedSongs.every(Boolean)) {
        document.getElementById('submitModal').style.display = 'flex';
        // Ensure confirmSubmit is called on Yes button
        document.querySelector('#submitModal button[onclick*="confirmSubmit(true)"]').onclick = function() {
          window.confirmSubmit(true);
        };
        document.querySelector('#submitModal button[onclick*="confirmSubmit(false)"]').onclick = function() {
          window.confirmSubmit(false);
        };
      }
    };
    document.getElementById('resetBtn').onclick = () => {
      if (rankedSongs.every(Boolean)) document.getElementById('resetModal').style.display = 'flex';
    };

    // Helper to format ranked list for sharing
    function getShareText() {
      const list = Array.from(document.querySelectorAll('#myRankingsList li')).map((li, i) => `${i+1}. ${li.textContent}`);
      return `My Top 20 NF Songs\n${list.join('\n')}\n\nRank your own: https://ranksongs.com/nf_ranks.html`;
    }

    // Update share buttons in results modal to share the actual list
    function updateShareLinks() {
      const text = encodeURIComponent(getShareText());
      const url = encodeURIComponent('https://ranksongs.com/nf_ranks.html');
      // X (Twitter)
      document.getElementById('share-x').href = `https://twitter.com/intent/tweet?text=${text}`;
      // Facebook (site link only)
      document.getElementById('share-fb').href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
    }

    // Copy list to clipboard for Facebook
    function copyListToClipboard() {
      const text = getShareText();
      navigator.clipboard.writeText(text).then(() => {
        const msg = document.getElementById('copyMsg');
        msg.textContent = 'Copied! Paste into your Facebook post.';
        msg.style.display = 'inline-block';
        setTimeout(() => { msg.style.display = 'none'; }, 2500);
      });
    }

    function copyListAndShareFacebook() {
      const text = getShareText();
      navigator.clipboard.writeText(text).then(() => {
        const msg = document.getElementById('copyMsg');
        msg.textContent = 'Copied! Paste into your Facebook post.';
        msg.style.display = 'inline-block';
        setTimeout(() => { msg.style.display = 'none'; }, 2500);
        // Open Facebook share dialog
        const url = encodeURIComponent('https://ranksongs.com/nf_ranks.html');
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
      });
    }

    // Call updateShareLinks when results modal is shown
    function showResultsModal() {
      updateShareLinks();
      document.getElementById('resultsModal').style.display = 'flex';
    }

    async function fetchGlobalRankings() {
      const { data, error } = await supabaseClient.from('nf_submissions').select();
      if (error) { alert('Error fetching global rankings: ' + error.message); return []; }

      // Use the same master list for consistency
      const allSongs = NF_SONGS;

      // Initialize stats for all songs
      const songStats = {};
      allSongs.forEach(song => {
        songStats[song] = { totalPoints: 0, timesRanked: 0, totalRankSum: 0, weightedRankings: 0, weightedCount: 0 };
      });

      const UNRANKED_WEIGHT = 0.5; // Weight for treating unranked songs as rank 0 (increased from 0.1)
      const MIN_VOTES_FOR_LEADERBOARD = Math.max(1, Math.ceil(data.length * 0.05)); // 5% of total submissions, minimum 1

      data.forEach(submission => {
        const rankedSongs = new Set();
        
        // First pass: collect actual rankings
        for (let i = 1; i <= 20; i++) {
          const song = submission['rank_' + i];
          if (!song) continue;
          if (!songStats[song]) songStats[song] = { totalPoints: 0, timesRanked: 0, totalRankSum: 0, weightedRankings: 0, weightedCount: 0 };
          songStats[song].totalPoints += 21 - i;
          songStats[song].timesRanked++;
          songStats[song].totalRankSum += i;
          songStats[song].weightedRankings += i; // Full weight for actual rankings
          songStats[song].weightedCount += 1;
          rankedSongs.add(song);
        }
        
        // Second pass: add low-confidence negative signal for unranked songs
        allSongs.forEach(song => {
          if (!rankedSongs.has(song)) {
            songStats[song].weightedRankings += 21 * UNRANKED_WEIGHT; // Rank 21 (worst) with low weight
            songStats[song].weightedCount += UNRANKED_WEIGHT;
          }
        });
      });

      const arr = Object.entries(songStats)
        .filter(([song, stats]) => stats.timesRanked >= MIN_VOTES_FOR_LEADERBOARD) // Filter by minimum votes
        .map(([song, stats]) => {
        const avgRank = stats.timesRanked > 0 ? stats.totalRankSum / stats.timesRanked : 21; // Default to worst rank if never ranked
        const weightedAvgRank = stats.weightedCount > 0 ? stats.weightedRankings / stats.weightedCount : 21;
        const rawScore = ((PRIOR_COUNT * PRIOR_AVG) + (stats.weightedCount * weightedAvgRank)) / (PRIOR_COUNT + stats.weightedCount);
        const weightedScore = 21 - rawScore;
        const timesUnranked = Math.round((stats.weightedCount - stats.timesRanked) / UNRANKED_WEIGHT); // Calculate times unranked
        return { 
          song, 
          totalPoints: stats.totalPoints, 
          timesRanked: stats.timesRanked, 
          avgRank, 
          weightedScore,
          weightedCount: stats.weightedCount.toFixed(1),
          timesUnranked: timesUnranked
        };
      });

      arr.sort((a, b) => b.weightedScore - a.weightedScore);
      globalRankings = arr;
      return arr;
    }

    function renderGlobalTable(data) {
      const tbody = document.querySelector('#globalRankingsTable tbody');
      tbody.innerHTML = '';
      data.forEach((entry, index) => {
        const tr = document.createElement('tr');
        const safeSong = entry.song.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${entry.song}</td>
          <td>${entry.avgRank.toFixed(2)}</td>
          <td>${entry.timesRanked}</td>
          <td>${entry.totalPoints}</td>
          <td><a href="#" onclick="event.preventDefault(); showCalculation('${safeSong}', ${entry.avgRank}, ${entry.timesRanked});">${entry.weightedScore.toFixed(2)}</a></td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.confirmSubmit = async function(confirmed) {
      document.getElementById('submitModal').style.display = 'none';
      if (!confirmed) return;

      const dataToInsert = {};
      rankedSongs.forEach((song, i) => { dataToInsert['rank_' + (i + 1)] = song; });

      // Best-effort IP (optional)
      let ip = '';
      try { const res = await fetch('https://api64.ipify.org?format=json'); ip = (await res.json()).ip; } catch {}
      dataToInsert.ip_address = ip;

      const { error } = await supabaseClient.from('nf_submissions').insert([dataToInsert]);
      if (error) { alert('Submission error: ' + error.message); return; }

      // Push event to dataLayer for GTM ‚Üí GA4 (and other pixels)
      if (window.dataLayer) {
        window.dataLayer.push({ event: 'submit_rankings', artist: 'NF', song_count: 20, top_song: rankedSongs[0] || '' });
      }

      // My list
      const myList = document.getElementById('myRankingsList');
      myList.innerHTML = '';
      rankedSongs.forEach(song => { const li = document.createElement('li'); li.textContent = song; myList.appendChild(li); });

      // Global
      const rankings = await fetchGlobalRankings();
      renderGlobalTable(rankings);
      showResultsModal(); // <-- instead of direct modal display

      // Reset
      rankedSongs = Array(20).fill(null);
      renderAll();
    };

    window.closeResults = function () {
      document.getElementById('resultsModal').style.display = 'none';
    };

    window.confirmReset = function(confirmed) {
      document.getElementById('resetModal').style.display = 'none';
      if (confirmed) {
        if (window.dataLayer) window.dataLayer.push({ event: 'reset_rankings', artist: 'NF' });
        rankedSongs = Array(20).fill(null);
        renderAll();
      }
    };

    function showCalculation(song, avgRank, timesRanked) {
      const rawScore = ((PRIOR_COUNT * PRIOR_AVG) + (timesRanked * avgRank)) / (PRIOR_COUNT + timesRanked);
      const weightedScore = 21 - rawScore;
      const details = `
        Song: <strong>${song}</strong><br><br>
        Formula:<br>
        ((${PRIOR_COUNT} √ó ${PRIOR_AVG}) + (${timesRanked} √ó ${avgRank.toFixed(2)})) √∑ (${PRIOR_COUNT} + ${timesRanked})<br><br>
        Raw Score: <strong>${rawScore.toFixed(4)}</strong><br>
        Weighted Score = 21 - Raw Score = <strong>${weightedScore.toFixed(2)}</strong>
      `;
      document.getElementById('calcDetails').innerHTML = details;
      document.getElementById('calcModal').style.display = 'flex';
    }
    window.showCalculation = showCalculation;

    // Init
    document.addEventListener("DOMContentLoaded", async () => {
      // Display random quote
      const quoteElement = document.getElementById('randomQuote');
      if (quoteElement) {
        quoteElement.textContent = getRandomQuote();
      }

      updateButtons('rankByToggles', currentMode);
      updateButtons('sortByToggles', sortType);
      renderAll();

      // Share link click tracking via dataLayer
      const xLink = document.getElementById('share-x');
      const fbLink = document.getElementById('share-fb');
      if (xLink) xLink.addEventListener('click', () => window.dataLayer && window.dataLayer.push({event:'share', platform:'x', artist:'NF'}));
      if (fbLink) {
        fbLink.addEventListener('click', function(e) {
          e.preventDefault();
          openFbCopyModal();
          window.dataLayer && window.dataLayer.push({event:'share', platform:'facebook', artist:'NF'});
        });
      }
      // Facebook modal buttons
      document.getElementById('fbCopyYes').onclick = function() { fbShare(true); };
      document.getElementById('fbCopyNo').onclick = function() { fbShare(false); };
    });

    // Facebook share button logic
    function openFbCopyModal() {
      document.getElementById('fbCopyModal').style.display = 'flex';
    }
    function fbShare(shouldCopy) {
      document.getElementById('fbCopyModal').style.display = 'none';
      if (shouldCopy) copyListToClipboard();
      const url = encodeURIComponent('https://ranksongs.com/nf_ranks.html');
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
    }
    document.getElementById('fbCopyYes').onclick = function() { fbShare(true); };
    document.getElementById('fbCopyNo').onclick = function() { fbShare(false); };
    document.getElementById('share-fb').onclick = function(e) {
      e.preventDefault();
      openFbCopyModal();
    };
  </script>

  <!-- Calculation modal -->
  <div id="calcModal" class="modal">
    <div class="modal-content">
      <h3>Composite Score Calculation</h3>
      <p id="calcDetails"></p>
      <button onclick="document.getElementById('calcModal').style.display='none'">Close</button>
    </div>
  </div>
</body>
</html>
